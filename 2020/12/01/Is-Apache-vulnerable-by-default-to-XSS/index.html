<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Is Apache vulnerable by default to XSS? · ReverseBrain | Cybersecurity Blog</title><meta name="description" content="Is Apache vulnerable by default to XSS? - ReverseBrain"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://reversebrain.github.io/atom.xml" title="ReverseBrain | Cybersecurity Blog"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="ReverseBrain | Cybersecurity Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/reversebrain" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Is Apache vulnerable by default to XSS?</h1><div class="post-info">Dec 1, 2020</div><div class="post-content"><h1 id="Apache-vs-httpd"><a href="#Apache-vs-httpd" class="headerlink" title="Apache vs httpd"></a>Apache vs httpd</h1><p>Before starting, let’s clarify if Apache and httpd are different web servers. They are the same application, just that some Linux distributions refer to it differently within package managers and config files. RedHat-based distros (CentOS, Fedora) refer to it as httpd while Debian-based distros (Ubuntu) refer to it as apache. Gentoo, strangely enough, mostly refers to it as apache but config files have httpd in the naming conventions.</p>
<a id="more"></a>

<h1 id="Content-Negotiation"><a href="#Content-Negotiation" class="headerlink" title="Content Negotiation"></a>Content Negotiation</h1><p>Apache HTTPD supports content negotiation as described in the HTTP/1.1 specification. It can choose the best representation of a resource based on the browser-supplied preferences for media type, languages, character set and encoding. It also implements a couple of features to give more intelligent handling of requests from browsers that send incomplete negotiation information.</p>
<p>Content negotiation is provided by the mod_negotiation module, which is compiled in by default.</p>
<p>A resource may be available in several different representations. For example, it might be available in different languages or different media types, or a combination. One way of selecting the most appropriate choice is to give the user an index page, and let them select. However it is often possible for the server to choose automatically. This works because browsers can send, as part of each request, information about what representations they prefer. For example, a browser could indicate that it would like to see information in French, if possible, else English will do. Browsers indicate their preferences by headers in the request. To request only French representations, the browser would send</p>
<p><code>Accept-Language: fr</code></p>
<p>Note that this preference will only be applied when there is a choice of representations and they vary by language.</p>
<p>As an example of a more complex request, this browser has been configured to accept French and English, but prefer French, and to accept various media types, preferring HTML over plain text or other text types, and preferring GIF or JPEG over other media types, but also allowing any other media type as a last resort:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Accept-Language: fr; q&#x3D;1.0, en; q&#x3D;0.5</span><br><span class="line">Accept: text&#x2F;html; q&#x3D;1.0, text&#x2F;*; q&#x3D;0.8, image&#x2F;gif; q&#x3D;0.6, image&#x2F;jpeg; q&#x3D;0.6, image&#x2F;*; q&#x3D;0.5, *&#x2F;*; q&#x3D;0.1</span><br></pre></td></tr></table></figure>

<p>httpd supports ‘server driven’ content negotiation, as defined in the HTTP/1.1 specification. It fully supports the Accept, Accept-Language, Accept-Charset and Accept-Encoding request headers. httpd also supports ‘transparent’ content negotiation, which is an experimental negotiation protocol defined in RFC 2295 and RFC 2296. It does not offer support for ‘feature negotiation’ as defined in these RFCs.</p>
<h1 id="Negotiation-in-httpd"><a href="#Negotiation-in-httpd" class="headerlink" title="Negotiation in httpd"></a>Negotiation in httpd</h1><p>In order to negotiate a resource, the server needs to be given information about each of the variants. This is done in one of two ways:</p>
<ul>
<li>Using a type map (i.e., a *.var file) which names the files containing the variants explicitly, or</li>
<li>Using a ‘MultiViews’ search, where the server does an implicit filename pattern match and chooses from among the results.</li>
</ul>
<p>We will focus on the first way.</p>
<p>A type map is a document which is associated with the handler named type-map (or, for backwards-compatibility with older httpd configurations, the MIME-type application/x-type-map). Note that to use this feature, you must have a handler set in the configuration that defines a file suffix as type-map; this is best done with</p>
<p><code>AddHandler type-map .var</code></p>
<p>in the server configuration file.</p>
<p>At this time you can be confused, just keep reading and everything will be clear.</p>
<h1 id="XSS-in-var-file"><a href="#XSS-in-var-file" class="headerlink" title="XSS in .var file"></a>XSS in .var file</h1><p>Let’s create a simple Dockerfile to start an httpd container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM httpd:alpine</span><br><span class="line">COPY .&#x2F;htdocs&#x2F; &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;htdocs&#x2F;</span><br></pre></td></tr></table></figure>
<p>and copy <em>xss.var</em> file inside <em>htdocs</em> folder.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Content-language: en</span><br><span class="line">Content-type: text&#x2F;html</span><br><span class="line">Body:----foo----</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">alert(1)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">----foo----</span><br></pre></td></tr></table></figure>
<p>Now we can start the container and check if the XSS is triggered.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t apache-xss .</span><br><span class="line">docker run -dit --name apache-xss --rm -p 8081:80 apache-xss</span><br></pre></td></tr></table></figure>
<p>Navigating to <em>/xss.var</em> nothing happened, the file is rendered as text. Ok, trust me, I am not lying, just keep reading.<br><img src="/2020/12/01/Is-Apache-vulnerable-by-default-to-XSS/xss_var_1.png"></p>
<p>Let’s first understand why this doesn’t work, this is the <em>httpd.conf</em> file line which prevents the XSS:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#AddHandler type-map var</span><br></pre></td></tr></table></figure>
<p>So, in <em>httpd</em>, the var handler directive is commented and so disabled by default but this is not true for <em>apache2</em> package in Debian-based distributions, let’s create another container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM debian:buster</span><br><span class="line">RUN apt update &amp;&amp; apt install -y apache2</span><br><span class="line">COPY .&#x2F;htdocs&#x2F; &#x2F;var&#x2F;www&#x2F;html&#x2F;</span><br><span class="line">CMD apachectl -D FOREGROUND</span><br></pre></td></tr></table></figure>
<p>Start it again as we did before.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t apache-xss .</span><br><span class="line">docker run -dit --name apache-xss --rm -p 8081:80 apache-xss</span><br></pre></td></tr></table></figure>
<p>What happens if I navigate again to <em>/xss.var</em>? A picture is worth more than a thousand words.<br><img src="/2020/12/01/Is-Apache-vulnerable-by-default-to-XSS/xss_var_2.png"></p>
<p>If we check <em>mods-available/mime.conf</em> file, we can discover that the var handler is enabled by default:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># For type maps (negotiated resources):</span><br><span class="line"># (This is enabled by default to allow the Apache &quot;It Worked&quot; page</span><br><span class="line">#  to be distributed in multiple languages.)</span><br><span class="line">#</span><br><span class="line">AddHandler type-map var</span><br></pre></td></tr></table></figure>

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Remember to use whitelist if you accept file upload in your website, in other cases disable the type-map var handler or you can be vulnerable to stored XSS.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2021/03/29/The-story-of-Nginx-and-uri-variable/" class="prev">PREV</a><a href="/2020/10/02/Break-the-PHP-LDAP-functions/" class="next">NEXT</a></div><div class="copyright"><p>© 2020 - 2021 <a href="https://reversebrain.github.io">ReverseBrain</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>